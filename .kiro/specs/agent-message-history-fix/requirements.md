# Requirements Document

## Introduction

Данная спецификация описывает улучшение системы агентов для корректной работы с историей сообщений и контекстом диалога. В настоящее время агенты получают историю сообщений из базы данных, но не используют её эффективно при генерации ответов, так как плейсхолдеры в промптах не заменяются на реальные данные.

## Requirements

### Requirement 1: Корректная замена плейсхолдеров истории в промптах

**User Story:** Как разработчик системы, я хочу, чтобы плейсхолдеры `{{messageHistory}}` в промптах агентов автоматически заменялись на реальную историю сообщений, чтобы агенты могли учитывать контекст диалога при генерации ответов.

#### Acceptance Criteria

1. WHEN агент получает задачу с историей сообщений THEN система SHALL заменить плейсхолдер `{{messageHistory}}` в промпте на форматированную историю сообщений
2. WHEN история сообщений пуста THEN система SHALL заменить плейсхолдер `{{messageHistory}}` на пустую строку или сообщение "История диалога пуста"
3. WHEN промпт содержит другие плейсхолдеры (`{{userId}}`, `{{currentTime}}`, `{{timezone}}`, `{{householdId}}`) THEN система SHALL заменить их на соответствующие значения из контекста задачи
4. WHEN форматированная история превышает максимальную длину THEN система SHALL обрезать историю, сохраняя последние сообщения

### Requirement 2: Улучшенное форматирование истории для промптов

**User Story:** Как AI агент, я хочу получать историю сообщений в удобном для анализа формате, чтобы я мог лучше понимать контекст диалога и давать более релевантные ответы.

#### Acceptance Criteria

1. WHEN система форматирует историю сообщений THEN каждое сообщение SHALL содержать временную метку, роль отправителя и содержимое
2. WHEN в истории есть последовательные сообщения от одного пользователя THEN система SHALL объединять их в одно сообщение для компактности
3. WHEN история содержит системные сообщения THEN система SHALL включать их только если они релевантны для контекста
4. WHEN форматируется история THEN система SHALL использовать формат: `[ЧЧ:ММ] Роль: Содержимое`

### Requirement 3: Контекстная информация в промптах

**User Story:** Как AI агент, я хочу получать актуальную контекстную информацию (ID пользователя, время, часовой пояс), чтобы я мог давать персонализированные и своевременные ответы.

#### Acceptance Criteria

1. WHEN агент обрабатывает задачу THEN система SHALL заменить `{{userId}}` на ID текущего пользователя
2. WHEN агент обрабатывает задачу THEN система SHALL заменить `{{currentTime}}` на текущее время в формате ISO-8601
3. WHEN агент обрабатывает задачу THEN система SHALL заменить `{{timezone}}` на часовой пояс пользователя или системный часовой пояс по умолчанию
4. WHEN агент обрабатывает задачу AND пользователь принадлежит к домохозяйству THEN система SHALL заменить `{{householdId}}` на ID домохозяйства
5. IF плейсхолдер не может быть заменен (нет данных) THEN система SHALL заменить его на значение по умолчанию или пустую строку

### Requirement 4: Оптимизация размера контекста

**User Story:** Как система, я хочу оптимизировать размер передаваемого контекста в AI модель, чтобы снизить затраты на токены и ускорить обработку запросов.

#### Acceptance Criteria

1. WHEN история сообщений превышает лимит токенов THEN система SHALL использовать умную обрезку, сохраняя последние и важные сообщения
2. WHEN агент использует структурированный контекст THEN система SHALL передавать только релевантную информацию из истории
3. WHEN история содержит длинные сообщения THEN система SHALL обрезать их с сохранением смысла
4. WHEN система оценивает размер контекста THEN она SHALL использовать приблизительный подсчет токенов (1 токен ≈ 4 символа для русского языка)

### Requirement 5: Тестирование работы с историей

**User Story:** Как разработчик, я хочу иметь возможность тестировать работу агентов с различными сценариями истории сообщений, чтобы убедиться в корректности обработки контекста.

#### Acceptance Criteria

1. WHEN разработчик запускает тесты THEN система SHALL проверять корректность замены всех плейсхолдеров
2. WHEN разработчик запускает тесты THEN система SHALL проверять форматирование истории для различных сценариев (пустая история, короткая, длинная)
3. WHEN разработчик запускает тесты THEN система SHALL проверять обрезку истории при превышении лимитов
4. WHEN разработчик запускает тесты THEN система SHALL проверять работу с различными типами сообщений (user, assistant, system, tool)

### Requirement 6: Логирование и отладка

**User Story:** Как разработчик, я хочу видеть, какая история сообщений и контекст передаются агентам, чтобы я мог отлаживать проблемы с обработкой диалогов.

#### Acceptance Criteria

1. WHEN агент обрабатывает задачу THEN система SHALL логировать количество сообщений в истории
2. WHEN система заменяет плейсхолдеры THEN она SHALL логировать предупреждения о недостающих данных
3. WHEN история обрезается THEN система SHALL логировать информацию об обрезке (исходный размер, финальный размер)
4. IF включен режим отладки THEN система SHALL логировать полный промпт с замененными плейсхолдерами
