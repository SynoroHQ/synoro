# Implementation Plan

- [x] 1. Создать PromptContextService
  - Создать новый файл `packages/api/src/lib/services/prompt-context-service.ts`
  - Реализовать основной метод `processPrompt()` для обработки промптов
  - Реализовать метод `replaceMessageHistory()` для замены плейсхолдера истории
  - Реализовать метод `replaceContextPlaceholders()` для замены контекстных плейсхолдеров
  - _Requirements: 1.1, 1.2, 1.3, 3.1, 3.2, 3.3, 3.4, 3.5_

- [x] 2. Реализовать форматирование и оптимизацию истории
  - Реализовать метод `formatMessageHistory()` для форматирования истории сообщений
  - Реализовать метод `optimizeHistorySize()` для умной обрезки истории
  - Реализовать метод `estimateTokens()` для оценки количества токенов
  - Добавить логику объединения последовательных сообщений от одного пользователя
  - _Requirements: 1.4, 2.1, 2.2, 2.3, 2.4, 4.1, 4.2, 4.3, 4.4_

- [x] 3. Добавить типы и интерфейсы
  - Создать интерфейс `PromptContextOptions` в `packages/api/src/lib/services/prompt-context-service.ts`
  - Создать интерфейс `ProcessedPrompt` для результата обработки
  - Добавить типы для метаданных обработки
  - _Requirements: 1.1, 4.1_

- [x] 4. Интегрировать PromptContextService в BaseAgent
  - Добавить `promptContextService` как protected поле в `AbstractAgent`
  - Обновить метод `createOptimizedPrompt()` для использования нового сервиса
  - Добавить feature flag `USE_PROMPT_CONTEXT_SERVICE` для постепенного внедрения
  - Сохранить старую логику как fallback
  - _Requirements: 1.1, 1.2, 1.3, 1.4_

- [ ] 5. Добавить логирование и отладку
  - Добавить логирование количества сообщений в истории
  - Добавить логирование предупреждений о недостающих данных
  - Добавить логирование информации об обрезке истории
  - Добавить условное логирование полного промпта при `DEBUG_PROMPTS=true`
  - _Requirements: 6.1, 6.2, 6.3, 6.4_

- [ ] 6. Обновить обработку ошибок
  - Добавить try-catch блоки в `processPrompt()`
  - Реализовать fallback к промпту без обработки при ошибках
  - Добавить значения по умолчанию для отсутствующих плейсхолдеров
  - Добавить сбор предупреждений в метаданные
  - _Requirements: 3.5, 6.2_

- [x] 7. Обновить существующие агенты
  - Убедиться, что EventProcessorAgent использует обновленный BaseAgent
  - Убедиться, что EventAnalyzerAgent использует обновленный BaseAgent
  - Убедиться, что GeneralAssistantAgent использует обновленный BaseAgent
  - Убедиться, что RouterAgent использует обновленный BaseAgent
  - _Requirements: 1.1, 1.2, 1.3_

- [ ] 8. Добавить переменные окружения
  - Добавить `USE_PROMPT_CONTEXT_SERVICE` в `.env.example`
  - Добавить `DEBUG_PROMPTS` в `.env.example`
  - Документировать новые переменные окружения
  - _Requirements: 6.4_

- [ ] 9. Обновить документацию
  - Добавить описание PromptContextService в README или документацию
  - Добавить примеры использования плейсхолдеров в промптах
  - Документировать опции конфигурации
  - Добавить руководство по отладке проблем с контекстом
  - _Requirements: 6.1, 6.2, 6.3, 6.4_

- [ ] 10. Проверить работу в реальных сценариях
  - Протестировать с пустой историей сообщений
  - Протестировать с короткой историей (2-3 сообщения)
  - Протестировать с длинной историей (50+ сообщений)
  - Протестировать с различными типами сообщений (user, assistant, system)
  - Проверить корректность замены всех плейсхолдеров
  - Проверить работу обрезки истории
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 2.1, 2.2, 2.3, 2.4, 4.1, 4.2, 4.3_
