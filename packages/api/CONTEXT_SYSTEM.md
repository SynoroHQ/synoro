# –°–∏—Å—Ç–µ–º–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è AI –±–µ—Å–µ–¥

## –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç –±–æ—Ç—É –ø–æ–º–Ω–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ –±–µ—Å–µ–¥–µ –∏ —É—á–∏—Ç—ã–≤–∞—Ç—å –∏—Ö –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤. –≠—Ç–æ –¥–µ–ª–∞–µ—Ç –æ–±—â–µ–Ω–∏–µ –±–æ–ª–µ–µ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ-–∑–∞–≤–∏—Å–∏–º—ã–º.

## –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. Context Manager (`src/lib/context-manager.ts`)

–û—Å–Ω–æ–≤–Ω–æ–π –º–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –±–µ—Å–µ–¥—ã:

- `getConversationContext()` - –ø–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –±–µ—Å–µ–¥—ã
- `saveMessageToConversation()` - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
- `trimContextByTokens()` - —É–º–Ω–∞—è –æ–±—Ä–µ–∑–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- `estimateTokenCount()` - –æ—Ü–µ–Ω–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–∫–µ–Ω–æ–≤

### 2. –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å–æ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π

–í `src/router/messages/process-message.ts` –¥–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:

- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –±–µ—Å–µ–¥—ã
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- –ü–µ—Ä–µ–¥–∞—á–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤ AI —Ñ—É–Ω–∫—Ü–∏–∏
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ AI —Ñ—É–Ω–∫—Ü–∏–∏

–í `src/lib/ai/advisor.ts`:

- `answerQuestion()` - —É—á–∏—Ç—ã–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–∏ –æ—Ç–≤–µ—Ç–∞—Ö
- `advise()` - –¥–∞–µ—Ç —Å–æ–≤–µ—Ç—ã —Å —É—á–µ—Ç–æ–º –∏—Å—Ç–æ—Ä–∏–∏

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1. –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

```typescript
// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –±–µ—Å–µ–¥—ã
const conversationContext = await getConversationContext(
  ctx,
  userId,
  channel,
  chatId,
  {
    maxMessages: 20,
    includeSystemMessages: false,
    maxAgeHours: 48,
  },
);
```

### 2. –£–º–Ω–∞—è –æ–±—Ä–µ–∑–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

```typescript
// –ê–¥–∞–ø—Ç–∏–≤–Ω–∞—è –æ–±—Ä–µ–∑–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
const maxTokens = text.includes("?") || text.length < 50 ? 2000 : 1000;
const trimmedContext = trimContextByTokens(
  conversationContext.messages,
  maxTokens,
);
```

### 3. –ü–µ—Ä–µ–¥–∞—á–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤ AI

```typescript
const classification = await classifyMessage(text, {
  functionId: "api-message-classifier",
  metadata: {
    // ... –¥—Ä—É–≥–∏–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
    context: trimmedContext, // –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –∑–¥–µ—Å—å
  },
});
```

### 4. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –≤ AI —Ñ—É–Ω–∫—Ü–∏—è—Ö

```typescript
// –í answerQuestion()
const context = (telemetry?.metadata?.context as ContextMessage[]) || [];

let conversationHistory = "";
if (context.length > 0) {
  conversationHistory = "\n\n–ò—Å—Ç–æ—Ä–∏—è –±–µ—Å–µ–¥—ã:\n";
  context.forEach((msg, index) => {
    const role = msg.role === "user" ? "–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å" : "–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç";
    conversationHistory += `${index + 1}. ${role}: ${msg.content.text}\n`;
  });
}
```

## –°—Ç—Ä–∞—Ç–µ–≥–∏—è —É–º–Ω–æ–π –æ–±—Ä–µ–∑–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π:

1. **–ü–æ—Å–ª–µ–¥–Ω–∏–µ 2 —Å–æ–æ–±—â–µ–Ω–∏—è** - –≤—Å–µ–≥–¥–∞ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è (—Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ç–µ–∫—Å—Ç)
2. **–í–∞–∂–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è**:
   - –°–æ–¥–µ—Ä–∂–∞—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã (—Å "?")
   - –î–ª–∏–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (>100 —Å–∏–º–≤–æ–ª–æ–≤)
   - –° –∫–ª—é—á–µ–≤—ã–º–∏ —Å–ª–æ–≤–∞–º–∏: "–∫–∞–∫", "—á—Ç–æ", "–≥–¥–µ", "–ø–æ–º–æ–≥–∏", etc.
3. **–û—Å—Ç–∞–ª—å–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è** - –∑–∞–ø–æ–ª–Ω—è—é—Ç –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –º–µ—Å—Ç–æ

### –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –ª–∏–º–∏—Ç—ã —Ç–æ–∫–µ–Ω–æ–≤:

- **2000 —Ç–æ–∫–µ–Ω–æ–≤** - –¥–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –∫–æ—Ä–æ—Ç–∫–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–±–æ–ª—å—à–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)
- **1000 —Ç–æ–∫–µ–Ω–æ–≤** - –¥–ª—è —Å–æ–±—ã—Ç–∏–π –∏ –¥–ª–∏–Ω–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–º–µ–Ω—å—à–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞)

## –•—Ä–∞–Ω–µ–Ω–∏–µ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–∞–±–ª–∏—Ü:

```sql
-- –ë–µ—Å–µ–¥—ã
conversations:
  - id (primary key)
  - owner_user_id (FK to users)
  - channel (telegram/web/mobile)
  - title (–¥–ª—è Telegram = chatId)
  - status, created_at, updated_at, last_message_at

-- –°–æ–æ–±—â–µ–Ω–∏—è
messages:
  - id (primary key)
  - conversation_id (FK to conversations)
  - role (user/assistant/system/tool)
  - content (JSONB —Å —Ç–µ–∫—Å—Ç–æ–º)
  - model, status, parent_id, created_at
```

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –±–µ—Å–µ–¥:

- –ë–µ—Å–µ–¥–∞ —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
- –î–ª—è Telegram: `title` = `chatId`
- –î–ª—è Web/Mobile: `title` = `{channel}_conversation`

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:

```typescript
interface ContextOptions {
  maxMessages?: number; // –ú–∞–∫—Å. —Å–æ–æ–±—â–µ–Ω–∏–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 10)
  includeSystemMessages?: boolean; // –í–∫–ª—é—á–∞—Ç—å —Å–∏—Å—Ç–µ–º–Ω—ã–µ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: false)
  maxAgeHours?: number; // –ú–∞–∫—Å. –≤–æ–∑—Ä–∞—Å—Ç –≤ —á–∞—Å–∞—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: 24)
}
```

### –õ–∏–º–∏—Ç—ã —Ç–æ–∫–µ–Ω–æ–≤:

- –û—Ü–µ–Ω–∫–∞: ~4 —Å–∏–º–≤–æ–ª–∞ = 1 —Ç–æ–∫–µ–Ω (–¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞)
- Overhead: ~50 —Å–∏–º–≤–æ–ª–æ–≤ –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
- –ú–∞–∫—Å–∏–º—É–º: 2000 —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤, 1000 –¥–ª—è —Å–æ–±—ã—Ç–∏–π

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç:

```bash
bun run packages/api/src/scripts/test-context.ts
```

–¢–µ—Å—Ç –ø—Ä–æ–≤–µ—Ä—è–µ—Ç:

- –ü–æ–¥—Å—á–µ—Ç —Ç–æ–∫–µ–Ω–æ–≤
- –û–±—Ä–µ–∑–∫—É –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –≤–∞–∂–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è AI

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–°–∏—Å—Ç–µ–º–∞ –≤—ã–≤–æ–¥–∏—Ç –ø–æ–ª–µ–∑–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –∫–æ–Ω—Å–æ–ª—å:

```
üìö –ö–æ–Ω—Ç–µ–∫—Å—Ç –±–µ—Å–µ–¥—ã: 5 —Å–æ–æ–±—â–µ–Ω–∏–π (ID: conv_123...)
üöÄ Using unified message classification with context
‚è±Ô∏è Classification took 150ms
```

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏:

1. **–õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞** - –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
2. **–£–º–Ω–∞—è –æ–±—Ä–µ–∑–∫–∞** - —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç–æ–ª—å–∫–æ –≤–∞–∂–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
3. **–ê–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –ª–∏–º–∏—Ç—ã** - —Ä–∞–∑–Ω—ã–µ –ª–∏–º–∏—Ç—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π
4. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** - –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –∫ –ë–î

### –ú–µ—Ç—Ä–∏–∫–∏:

- **–í—Ä–µ–º—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞**: ~20-50ms
- **–í—Ä–µ–º—è –æ–±—Ä–µ–∑–∫–∏**: ~1-5ms
- **Overhead —Ç–æ–∫–µ–Ω–æ–≤**: ~10-15% –æ—Ç –ª–∏–º–∏—Ç–∞

## –ë—É–¥—É—â–∏–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–°–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–µ —Å–∂–∞—Ç–∏–µ** - —Å–∂–∞—Ç–∏–µ —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –∫—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ
2. **–í–∞–∂–Ω–æ—Å—Ç—å –ø–æ –≤—Ä–µ–º–µ–Ω–∏** - —É—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –≤–∞–∂–Ω–æ—Å—Ç–∏
3. **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏** - –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–∏–º–∏—Ç–æ–≤ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
4. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞** - Redis –∫—ç—à –¥–ª—è —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –±–µ—Å–µ–¥
