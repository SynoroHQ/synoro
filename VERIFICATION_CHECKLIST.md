# –ß–µ–∫–ª–∏—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è

### 1. –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

- [x] –î–æ–±–∞–≤–ª–µ–Ω `USE_PROMPT_CONTEXT_SERVICE="true"` –≤ `.env`
- [x] –î–æ–±–∞–≤–ª–µ–Ω `DEBUG_PROMPTS="true"` –≤ `.env`
- [x] –û–±–Ω–æ–≤–ª–µ–Ω `.env.example` —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π

### 2. PromptContextService

- [x] –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ `{{eventContext}}`
- [x] –î–æ–±–∞–≤–ª–µ–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è `eventContext`
- [x] –í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–º–µ–Ω—è—é—Ç—Å—è

### 3. –ö–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏

- [x] –î–æ–±–∞–≤–ª–µ–Ω `timezone` –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ `AgentTask`
- [x] `timezone` –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: "Europe/Moscow"

### 4. getPrompt()

- [x] –û–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ `USE_PROMPT_CONTEXT_SERVICE`
- [x] –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Langfuse `compile()` –∫–æ–≥–¥–∞ —Ñ–ª–∞–≥ –≤–∫–ª—é—á–µ–Ω
- [x] –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–æ–º–ø—Ç —Å –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–∞–º–∏ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏

### 5. –ê–≥–µ–Ω—Ç—ã

- [x] `general-assistant-agent.ts` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `PromptContextService`
- [x] `event-processor-agent.ts` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `PromptContextService`
- [x] `event-analyzer-agent.ts` - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `PromptContextService`
- [x] `router-agent.ts` - —É–∂–µ —Ä–∞–±–æ—Ç–∞–ª –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### 6. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

- [x] –í—Å–µ –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã –∑–∞–º–µ–Ω—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [x] –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- [x] –ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ä–∞–±–æ—Ç–∞—é—Ç
- [x] –ù–µ—Ç –æ—à–∏–±–æ–∫ –∫–æ–º–ø–∏–ª—è—Ü–∏–∏

## üîç –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

```bash
# –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
grep USE_PROMPT_CONTEXT_SERVICE .env
grep DEBUG_PROMPTS .env
```

–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:

```
USE_PROMPT_CONTEXT_SERVICE="true"
DEBUG_PROMPTS="true"
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞

1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±–æ—Ç—É: "–ü—Ä–∏–≤–µ—Ç!"
2. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –µ—â–µ –æ–¥–Ω–æ: "–ü–æ—Ç—Ä–∞—Ç–∏–ª 1500‚ÇΩ –Ω–∞ –ø—Ä–æ–¥—É–∫—Ç—ã"
3. –û—Ç–ø—Ä–∞–≤—å—Ç–µ: "–ü–æ–∫–∞–∂–∏ –º–æ–∏ —Ç—Ä–∞—Ç—ã"

**–û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:**

- –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –ø–æ–º–Ω–∏—Ç—å –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- –ë–æ—Ç –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ–±—ã—Ç–∏–π
- –í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –≤–∏–¥–Ω—ã –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø—Ä–æ–º–ø—Ç–∞

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤

–ü—Ä–∏ `DEBUG_PROMPTS="true"` –≤ –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–ø–∏—Å–∏:

```
Prompt processing completed: {
  historyMessagesCount: 2,
  historyTruncated: false,
  placeholdersReplaced: ["messageHistory", "userId", "currentTime", "timezone", "householdId", "eventContext"],
  estimatedTokens: 85,
  warnings: []
}
```

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ Langfuse

1. –û—Ç–∫—Ä–æ–π—Ç–µ Langfuse Dashboard
2. –ù–∞–π–¥–∏—Ç–µ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Ç—Ä–µ–π—Å—ã
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤ –ø—Ä–æ–º–ø—Ç–∞—Ö:
   - –ù–µ—Ç –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–æ–≤ `{{...}}`
   - –ï—Å—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è userId, householdId, timezone
   - –ï—Å—Ç—å –∏—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
   - –ï—Å—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ–±—ã—Ç–∏–π

## üêõ –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### –ü—Ä–æ–±–ª–µ–º–∞: –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã –Ω–µ –∑–∞–º–µ–Ω—è—é—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:**

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `USE_PROMPT_CONTEXT_SERVICE="true"` –≤ `.env`
2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫

### –ü—Ä–æ–±–ª–µ–º–∞: –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –ø—É—Å—Ç–∞—è

**–†–µ—à–µ–Ω–∏–µ:**

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `conversationId` –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ `getConversationHistory`

### –ü—Ä–æ–±–ª–µ–º–∞: Timezone –Ω–µ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:**

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `metadata.timezone` –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏
2. –ï—Å–ª–∏ –Ω–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é "Europe/Moscow"

### –ü—Ä–æ–±–ª–µ–º–∞: eventContext –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è

**–†–µ—à–µ–Ω–∏–µ:**

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –∞–≥–µ–Ω—Ç –¥–æ–±–∞–≤–ª—è–µ—Ç `eventContext` –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏
2. –î–ª—è `event-processor-agent` –∏ `event-analyzer-agent` —ç—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–±—ã—Ç–∏–π

## üìä –ú–µ—Ç—Ä–∏–∫–∏ —É—Å–ø–µ—Ö–∞

–ü–æ—Å–ª–µ –≤–Ω–µ–¥—Ä–µ–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:

‚úÖ **–í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–º–µ–Ω—è—é—Ç—Å—è:**

- `{{userId}}` ‚Üí —Ä–µ–∞–ª—å–Ω—ã–π ID –∏–ª–∏ "anonymous"
- `{{householdId}}` ‚Üí —Ä–µ–∞–ª—å–Ω—ã–π ID –∏–ª–∏ "none"
- `{{currentTime}}` ‚Üí ISO timestamp
- `{{timezone}}` ‚Üí "Europe/Moscow" –∏–ª–∏ –¥—Ä—É–≥–æ–π
- `{{messageHistory}}` ‚Üí —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è
- `{{eventContext}}` ‚Üí –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ–±—ã—Ç–∏–π

‚úÖ **–ò—Å—Ç–æ—Ä–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç:**

- –ë–æ—Ç –ø–æ–º–Ω–∏—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è
- –ò—Å—Ç–æ—Ä–∏—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç—Å—è —á–∏—Ç–∞–µ–º–æ
- –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ 10 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —Ä–∞–±–æ—Ç–∞–µ—Ç

‚úÖ **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:**

- –ü—Ä–∏ `DEBUG_PROMPTS=true` –≤—ã–≤–æ–¥—è—Ç—Å—è –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ
- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏—è—Ö –≤–∏–¥–Ω—ã
- –ù–µ—Ç –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö

‚úÖ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:**

- –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–º–ø—Ç–∞ –∑–∞–Ω–∏–º–∞–µ—Ç < 50ms
- –û—Ü–µ–Ω–∫–∞ —Ç–æ–∫–µ–Ω–æ–≤ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞
- –ò—Å—Ç–æ—Ä–∏—è –Ω–µ –æ–±—Ä–µ–∑–∞–µ—Ç—Å—è –±–µ–∑ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:** –°–ª–µ–¥–∏—Ç–µ –∑–∞ –ª–æ–≥–∞–º–∏ –ø–µ—Ä–≤—ã–µ 24 —á–∞—Å–∞
2. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å:** –°–æ–±–µ—Ä–∏—Ç–µ –æ—Ç–∑—ã–≤—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ –∫–∞—á–µ—Å—Ç–≤–µ –æ—Ç–≤–µ—Ç–æ–≤
3. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è:** –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ª–∏–º–∏—Ç—ã –∏—Å—Ç–æ—Ä–∏–∏
4. **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** –û–±–Ω–æ–≤–∏—Ç–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω—é—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –∫–æ–º–∞–Ω–¥—ã

## üìù –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- `PROMPT_CONTEXT_FIX.md` - –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
- `CONTEXT_VARIABLES_FIX_SUMMARY.md` - –∫—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞
- `.env.example` - –ø—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- `packages/api/src/lib/services/prompt-context-service.ts` - –∏—Å—Ö–æ–¥–Ω—ã–π –∫–æ–¥ —Å–µ—Ä–≤–∏—Å–∞
