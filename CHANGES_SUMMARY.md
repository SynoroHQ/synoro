# –°–≤–æ–¥–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

## üìã –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

1. `.env` - –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ `USE_PROMPT_CONTEXT_SERVICE` –∏ `DEBUG_PROMPTS`
2. `.env.example` - –æ–±–Ω–æ–≤–ª–µ–Ω —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π –Ω–æ–≤—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö

### –°–µ—Ä–≤–∏—Å—ã

3. `packages/api/src/lib/services/prompt-context-service.ts`
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ `{{eventContext}}`
   - –î–æ–±–∞–≤–ª–µ–Ω–æ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è `eventContext`

4. `packages/prompts/src/prompt-service.ts`
   - –û–±–Ω–æ–≤–ª–µ–Ω `getPrompt()` –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ `USE_PROMPT_CONTEXT_SERVICE`
   - –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Langfuse `compile()` –∫–æ–≥–¥–∞ —Ñ–ª–∞–≥ –≤–∫–ª—é—á–µ–Ω

### –†–æ—É—Ç–∏–Ω–≥

5. `packages/api/src/router/messages/process-message-agents.ts`
   - –î–æ–±–∞–≤–ª–µ–Ω `timezone` –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏

### –ê–≥–µ–Ω—Ç—ã

6. `packages/api/src/lib/agents/general-assistant-agent.ts`
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `PromptContextService.processPrompt()`
   - –ù–µ –ø–µ—Ä–µ–¥–∞–µ—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ `getPrompt()`

7. `packages/api/src/lib/agents/event-processor-agent.ts`
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `PromptContextService.processPrompt()`
   - –î–æ–±–∞–≤–ª—è–µ—Ç `eventContext` –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏

8. `packages/api/src/lib/agents/event-analyzer-agent.ts`
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `PromptContextService.processPrompt()`
   - –î–æ–±–∞–≤–ª—è–µ—Ç `eventContext` –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç –∑–∞–¥–∞—á–∏

### –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

9. `PROMPT_CONTEXT_FIX.md` - –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
10. `CONTEXT_VARIABLES_FIX_SUMMARY.md` - –∫—Ä–∞—Ç–∫–∞—è —Å–≤–æ–¥–∫–∞
11. `VERIFICATION_CHECKLIST.md` - —á–µ–∫–ª–∏—Å—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏
12. `QUICK_START_CONTEXT_FIX.md` - –±—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç
13. `CHANGES_SUMMARY.md` - —ç—Ç–æ—Ç —Ñ–∞–π–ª

## üîÑ –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ –∫–æ–¥–µ

### –î–æ

```typescript
// –ê–≥–µ–Ω—Ç—ã –ø–µ—Ä–µ–¥–∞–≤–∞–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ getPrompt()
const systemPrompt = await getPrompt(
  PROMPT_KEYS.GENERAL_ASSISTANT_AGENT,
  "latest",
  {
    userId: task.context.userId ?? "Unknown",
    householdId: task.context.householdId ?? "Unknown",
    currentTime: new Date().toISOString(),
  },
);
```

### –ü–æ—Å–ª–µ

```typescript
// –ê–≥–µ–Ω—Ç—ã –ø–æ–ª—É—á–∞—é—Ç –ø—Ä–æ–º–ø—Ç —Å –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–∞–º–∏
const basePrompt = await getPrompt(
  PROMPT_KEYS.GENERAL_ASSISTANT_AGENT,
  "latest",
);

// –ò –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç —á–µ—Ä–µ–∑ PromptContextService
const processed = this.promptContextService.processPrompt(basePrompt, task, {
  maxHistoryLength: 1500,
  maxHistoryMessages: 10,
  includeSystemMessages: false,
  maxHistoryTokens: 500,
});

// –ò—Å–ø–æ–ª—å–∑—É—é—Ç –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç
const { text } = await generateText({
  model: this.getModel(),
  system: processed.prompt,
  prompt: task.input,
});
```

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

- **–§–∞–π–ª–æ–≤ –∏–∑–º–µ–Ω–µ–Ω–æ:** 8
- **–§–∞–π–ª–æ–≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏:** 5
- **–°—Ç—Ä–æ–∫ –∫–æ–¥–∞ –¥–æ–±–∞–≤–ª–µ–Ω–æ:** ~150
- **–°—Ç—Ä–æ–∫ –∫–æ–¥–∞ —É–¥–∞–ª–µ–Ω–æ:** ~50
- **–ù–æ–≤—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è:** 2

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –ë—ã–ª–æ

‚ùå –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–µ –∑–∞–º–µ–Ω—è–ª–∏—Å—å –∏–ª–∏ –∑–∞–º–µ–Ω—è–ª–∏—Å—å —á–∞—Å—Ç–∏—á–Ω–æ  
‚ùå –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ –Ω–µ –ø–µ—Ä–µ–¥–∞–≤–∞–ª–∞—Å—å  
‚ùå –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ–±—ã—Ç–∏–π –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è  
‚ùå Timezone –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª

### –°—Ç–∞–ª–æ

‚úÖ –í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∑–∞–º–µ–Ω—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ  
‚úÖ –ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç—Å—è  
‚úÖ –ö–æ–Ω—Ç–µ–∫—Å—Ç —Å–æ–±—ã—Ç–∏–π –¥–æ—Å—Ç—É–ø–µ–Ω –∞–≥–µ–Ω—Ç–∞–º  
‚úÖ Timezone –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è —Å fallback –Ω–∞ "Europe/Moscow"  
‚úÖ –ó–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ä–∞–±–æ—Ç–∞—é—Ç  
‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –æ—Ç–ª–∞–¥–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã

## üîç –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ

| –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è           | –ò—Å—Ç–æ—á–Ω–∏–∫                    | –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é                        |
| -------------------- | --------------------------- | ----------------------------------- |
| `{{userId}}`         | `task.context.userId`       | "anonymous"                         |
| `{{householdId}}`    | `task.context.householdId`  | "none"                              |
| `{{currentTime}}`    | `new Date().toISOString()`  | —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è                       |
| `{{timezone}}`       | `task.context.timezone`     | "UTC"                               |
| `{{messageHistory}}` | `task.messageHistory`       | "–ò—Å—Ç–æ—Ä–∏—è –¥–∏–∞–ª–æ–≥–∞ –ø—É—Å—Ç–∞"             |
| `{{eventContext}}`   | `task.context.eventContext` | "–°–æ–±—ã—Ç–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã" |

## üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞

1. –û–±–Ω–æ–≤–∏—Ç–µ `.env` —Å –Ω–æ–≤—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏
2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ `bun run dev`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç–∞

### –ü—Ä–æ–¥–∞–∫—à–Ω

1. –û–±–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
2. –ó–∞–¥–µ–ø–ª–æ–π—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
3. –ú–æ–Ω–∏—Ç–æ—Ä—å—Ç–µ –ª–æ–≥–∏ –ø–µ—Ä–≤—ã–µ 24 —á–∞—Å–∞
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Langfuse —Ç—Ä–µ–π—Å—ã

## ‚ö†Ô∏è –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è

1. **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:** –ï—Å–ª–∏ `USE_PROMPT_CONTEXT_SERVICE=false`, —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ-—Å—Ç–∞—Ä–æ–º—É
2. **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–æ–º–ø—Ç–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç ~10-20ms
3. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ:** `DEBUG_PROMPTS=true` —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –æ–±—ä–µ–º –ª–æ–≥–æ–≤
4. **Langfuse:** –ü—Ä–æ–º–ø—Ç—ã –≤ Langfuse –¥–æ–ª–∂–Ω—ã —Å–æ–¥–µ—Ä–∂–∞—Ç—å –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä—ã `{{...}}`

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω—ã:

- ‚úÖ –Æ–Ω–∏—Ç-—Ç–µ—Å—Ç—ã `PromptContextService`
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã
- ‚úÖ –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram
- ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ Langfuse

## üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:

1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `VERIFICATION_CHECKLIST.md`
2. –ò–∑—É—á–∏—Ç–µ –ª–æ–≥–∏ —Å `DEBUG_PROMPTS=true`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Langfuse —Ç—Ä–µ–π—Å—ã
4. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∫–æ–º–∞–Ω–¥–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

---

**–î–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π:** 14 –æ–∫—Ç—è–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è:** 1.0.0  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É
