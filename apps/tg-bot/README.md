# Telegram Bot

Умный Telegram бот с интеграцией API для обработки сообщений с использованием AI.

## 🚀 Возможности

- **🤖 AI-обработка сообщений**: Классификация, анализ релевантности и интеллектуальные ответы
- **🎤 Транскрипция аудио**: Конвертация голосовых сообщений в текст через OpenAI Whisper
- **📋 Парсинг задач**: Извлечение структурированных задач из естественного языка
- **💬 Умные ответы**: Контекстуальные ответы на вопросы и общение
- **🔒 Rate Limiting**: Защита от спама и перегрузки
- **📝 Allowlist**: Ограничение доступа по ID чатов
- **🗂️ Логирование событий**: Сохранение релевантных сообщений в базу данных

## Быстрый старт

1. **Установка зависимостей**:

   ```bash
   bun install
   ```

2. **Настройка переменных окружения**:

   ```bash
   # Обязательно
   TELEGRAM_BOT_TOKEN=your_bot_token

   # API конфигурация
   API_BASE_URL=http://localhost:3000       # URL API сервера
   API_TOKEN=your_api_token                 # Токен для доступа к API (опционально)

   # Опционально - настройки безопасности
   TG_ALLOWED_CHAT_IDS=123456789,987654321  # ID разрешенных чатов через запятую
   TG_RATE_LIMIT_WINDOW_MS=60000            # Окно rate limiting в миллисекундах
   TG_RATE_LIMIT_LIMIT=30                   # Лимит сообщений в окне
   TG_MESSAGE_MAX_LENGTH=3000               # Максимальная длина сообщения

   # Опционально - настройки аудио
   TG_AUDIO_MAX_BYTES=8388608               # Максимальный размер аудио (8MB)
   TG_AUDIO_MAX_DURATION_SEC=120            # Максимальная длительность аудио (2 мин)
   TG_FETCH_TIMEOUT_MS=25000                # Таймаут скачивания файлов (25 сек)
   ```

3. **Запуск бота**:
   ```bash
   bun run dev    # Режим разработки
   bun run start  # Продакшн режим
   ```

## Разработка

- **Проверка типов**: `bun run typecheck`
- **Линтинг**: `bun run lint`
- **Сборка**: `bun run build`

## 🏗️ Архитектура

Бот использует модульную архитектуру с интеграцией API:

```
┌─────────────────┐
│   Telegram Bot  │
└─────────────────┘
         │
         ▼
┌─────────────────┐
│  Rate Limiting  │
│   & Security    │
└─────────────────┘
         │
         ▼
┌─────────────────┐    ┌─────────────────┐
│   Text Handler  │    │  Audio Handler  │
└─────────────────┘    └─────────────────┘
         │                       │
         ▼                       ▼
┌─────────────────────────────────────────┐
│          Message Service                │
│  ┌─────────────────┐  ┌─────────────────┐│
│  │  Process Text   │  │  Transcribe     ││
│  │    Messages     │  │     Audio       ││
│  └─────────────────┘  └─────────────────┘│
└─────────────────────────────────────────┘
         │
         ▼
┌─────────────────┐
│   tRPC Client   │
└─────────────────┘
         │
         ▼
┌─────────────────┐
│  Universal API  │
│   (AI Services) │
└─────────────────┘
```

### Компоненты

- **`src/bot.ts`** - Основная настройка бота и middleware
- **`src/handlers/`** - Обработчики разных типов сообщений
  - `text-handler.ts` - Обработка текстовых сообщений
  - `audio-handler.ts` - Обработка голосовых сообщений
  - `other-handler.ts` - Fallback для остальных типов
- **`src/services/`** - Бизнес-логика
  - `message-service.ts` - Интеграция с API для обработки сообщений
- **`src/api/`** - API клиенты
  - `client.ts` - tRPC клиент для взаимодействия с API
- **`src/utils/`** - Утилиты
  - `telegram-utils.ts` - Вспомогательные функции для работы с Telegram
- **`src/lib/`** - Общие библиотеки
  - `rate-limit.ts` - Rate limiting
