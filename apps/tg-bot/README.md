# Telegram Bot

Умный Telegram бот с интеграцией API для обработки сообщений с использованием AI.

## 🚀 Возможности

- **🤖 AI-обработка сообщений**: Классификация, анализ релевантности и интеллектуальные ответы
- **🎤 Транскрипция аудио**: Конвертация голосовых сообщений в текст через OpenAI Whisper
- **📋 Парсинг задач**: Извлечение структурированных задач из естественного языка
- **💬 Умные ответы**: Контекстуальные ответы на вопросы и общение
- **🎨 HTML форматирование**: Красивые сообщения с жирным текстом, курсивом, таблицами и списками
- **🔒 Rate Limiting**: Защита от спама и перегрузки
- **📝 Allowlist**: Ограничение доступа по ID чатов
- **🗂️ Логирование событий**: Сохранение релевантных сообщений в базу данных
- **⏱️ Настраиваемые таймауты**: Гибкая настройка времени ожидания для скачивания файлов

## Быстрый старт

1. **Установка зависимостей**:

   ```bash
   bun install
   ```

2. **Настройка переменных окружения**:

   ```bash
   # Обязательно
   TELEGRAM_BOT_TOKEN=your_bot_token

   # API конфигурация
   API_BASE_URL=http://localhost:3000       # URL API сервера
   API_TOKEN=your_api_token                 # Токен для доступа к API (опционально)

   # Опционально - настройки безопасности
   TG_ALLOWED_CHAT_IDS=123456789,987654321  # ID разрешенных чатов через запятую
   TG_RATE_LIMIT_WINDOW_MS=60000            # Окно rate limiting в миллисекундах
   TG_RATE_LIMIT_LIMIT=30                   # Лимит сообщений в окне
   TG_MESSAGE_MAX_LENGTH=3000               # Максимальная длина сообщения

   # Опционально - настройки аудио
   TG_AUDIO_MAX_BYTES=8388608               # Максимальный размер аудио (8MB)
   TG_AUDIO_MAX_DURATION_SEC=120            # Максимальная длительность аудио (2 мин)
   TG_FETCH_TIMEOUT_MS=60000                # Таймаут скачивания файлов (60 сек)
   ```

3. **Запуск бота**:
   ```bash
   bun run dev    # Режим разработки
   bun run start  # Продакшн режим
   ```

## Разработка

- **Проверка типов**: `bun run typecheck`
- **Линтинг**: `bun run lint`
- **Сборка**: `bun run build`

## 🏗️ Архитектура

Бот использует модульную архитектуру с интеграцией API:

```
┌─────────────────┐
│   Telegram Bot  │
└─────────────────┘
         │
         ▼
┌─────────────────┐
│  Rate Limiting  │
│   & Security    │
└─────────────────┘
         │
         ▼
┌─────────────────┐    ┌─────────────────┐
│   Text Handler  │    │  Audio Handler  │
└─────────────────┘    └─────────────────┘
         │                       │
         ▼                       ▼
┌─────────────────────────────────────────┐
│          Message Service                │
│  ┌─────────────────┐  ┌─────────────────┐│
│  │  Process Text   │  │  Transcribe     ││
│  │    Messages     │  │     Audio       ││
│  └─────────────────┘  └─────────────────┘│
└─────────────────────────────────────────┘
         │
         ▼
┌─────────────────┐
│   tRPC Client   │
└─────────────────┘
         │
         ▼
┌─────────────────┐
│  Universal API  │
│   (AI Services) │
└─────────────────┘
```

## 🎨 HTML Форматирование

Бот поддерживает красивое HTML форматирование сообщений с использованием встроенных утилит:

### Основные возможности

- **Заголовки**: `<b>Жирный текст</b>` для выделения важной информации
- **Курсив**: `<i>Наклонный текст</i>` для подзаголовков и цитат
- **Код**: `<code>моноширинный текст</code>` для технических терминов
- **Ссылки**: `<a href="url">текст ссылки</a>` для веб-ссылок
- **Таблицы**: Структурированное отображение данных
- **Списки**: Нумерованные и маркированные списки
- **Эмодзи**: Автоматическое добавление подходящих эмодзи

### Примеры использования

```typescript
import { HTMLMessageBuilder } from "./utils/html-message-builder";

// Простое сообщение
const message = HTMLMessageBuilder.createMessage({
  title: "Заголовок",
  content: "Содержимое сообщения",
  useEmojis: true,
});

// Таблица
const table = HTMLMessageBuilder.createTable({
  title: "Статистика",
  headers: ["Метрика", "Значение"],
  rows: [
    ["Пользователи", "1,234"],
    ["Доход", "50,000 ₽"],
  ],
});

// Список задач
const tasks = HTMLMessageBuilder.createList({
  title: "План на день",
  items: ["Задача 1", "Задача 2", "Задача 3"],
  type: "numbered",
});
```

### Автоматическое форматирование

Бот автоматически применяет HTML форматирование к ответам AI агентов:

- Выделяет важные слова жирным шрифтом
- Форматирует технические термины как код
- Создаёт структурированные списки
- Добавляет цветовые индикаторы для статусов

### Компоненты

- **`src/bot.ts`** - Основная настройка бота и middleware
- **`src/handlers/`** - Обработчики разных типов сообщений
  - `text-handler.ts` - Обработка текстовых сообщений
  - `audio-handler.ts` - Обработка голосовых сообщений
  - `other-handler.ts` - Fallback для остальных типов
- **`src/services/`** - Бизнес-логика
  - `message-service.ts` - Интеграция с API для обработки сообщений
- **`src/api/`** - API клиенты
  - `client.ts` - tRPC клиент для взаимодействия с API
- **`src/utils/`** - Утилиты
  - `telegram-utils.ts` - Вспомогательные функции для работы с Telegram
  - `telegram-formatter.ts` - HTML форматирование сообщений
  - `html-message-builder.ts` - Построитель HTML сообщений
  - `html-examples.ts` - Примеры использования HTML утилит
- **`src/lib/`** - Общие библиотеки
  - `rate-limit.ts` - Rate limiting

## 🔧 Решение проблем

### AbortError при скачивании аудио файлов

Если вы получаете ошибку `AbortError` при обработке аудио сообщений, это означает, что файл не успевает скачаться в установленное время. Решения:

1. **Увеличить таймаут скачивания**:

   ```bash
   TG_FETCH_TIMEOUT_MS=120000  # 2 минуты
   ```

2. **Уменьшить максимальный размер файла**:

   ```bash
   TG_AUDIO_MAX_BYTES=4194304  # 4MB вместо 8MB
   ```

3. **Уменьшить максимальную длительность аудио**:
   ```bash
   TG_AUDIO_MAX_DURATION_SEC=60  # 1 минута вместо 2
   ```

### Медленное соединение

Для пользователей с медленным интернетом рекомендуется:

- Увеличить `TG_FETCH_TIMEOUT_MS` до 120-180 секунд
- Уменьшить `TG_AUDIO_MAX_BYTES` до 2-4MB
- Установить `TG_AUDIO_MAX_DURATION_SEC` в 30-60 секунд
