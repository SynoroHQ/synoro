# Улучшения Telegram бота Synoro AI

## Обзор изменений

Бот теперь умеет не только записывать события, но и отвечать на различные типы вопросов с учетом контекста.

## Новые возможности

### 1. Умная классификация сообщений

Каждое сообщение классифицируется по типу:

- **QUESTION** (Вопрос) - не записывается в базу
  - `about_bot` - вопросы о боте и его возможностях
  - `general` - общие вопросы и просьбы о помощи
  - `data_query` - запросы к сохранённым данным
- **EVENT** (Событие) - записывается в базу
  - `purchase` - покупки и траты
  - `task` - задачи и планы
  - `health` - здоровье и спорт
  - `transport` - поездки и транспорт
  - `household` - домашние дела
- **CHAT** (Общение) - простые реплики, не записывается
- **IRRELEVANT** (Спам) - игнорируется

### 2. Контекстные ответы

Бот теперь дает разные типы ответов в зависимости от типа сообщения:

#### Вопросы о боте

```
Пользователь: "Что ты умеешь?"
Бот: "Я помогаю логировать события (покупки, задачи, встречи), анализировать расходы, выявлять паттерны в поведении и давать практические советы. Просто расскажи мне о событии или задай вопрос!"
```

#### Вопросы о данных

```
Пользователь: "Сколько я потратил?"
Бот: "Пока у меня нет данных о твоих тратах. Начни записывать покупки, например: 'Купил хлеб за 45 рублей' — и я смогу вести статистику!"
```

#### События для записи

```
Пользователь: "Купил хлеб за 45 рублей"
Бот: "Записал: 'Купил хлеб за 45 рублей'.
Совет: Рекомендую также записывать категорию покупки для лучшей аналитики расходов."
```

#### Простое общение

```
Пользователь: "Привет!"
Бот: "Привет! Готов помочь тебе с записью событий или ответить на вопросы. Что планируешь сегодня?"
```

### 3. Оптимизированное логирование

- События записываются в базу только когда это действительно нужно
- Добавлена информация о типе сообщения в метаданные
- Улучшена обработка ошибок

## Технические изменения

### Новые файлы:

- `packages/prompts/src/prompts/classifier.message-type.ts` - промпт для классификации типов сообщений

### Обновленные файлы:

- `apps/tg-bot/src/services/ai-service.ts` - добавлены функции `classifyMessageType()` и `answerQuestion()`
- `apps/tg-bot/src/handlers/text.ts` - полностью переписана логика обработки текстовых сообщений
- `packages/prompts/src/prompts/assistant.ts` - улучшен промпт ассистента для лучшего понимания контекста
- `packages/prompts/src/keys.ts` и `registry.ts` - добавлен новый ключ промпта

### Основные улучшения:

1. **Интеллектуальная обработка**: каждое сообщение сначала классифицируется, а затем обрабатывается соответствующим образом
2. **Меньше спама в базе**: записываются только релевантные события
3. **Лучший UX**: бот отвечает более естественно и полезно на разные типы запросов
4. **Контекстные ответы**: ответы адаптируются под тип вопроса или события

## Результаты тестирования

✅ Классификация работает корректно для всех типов сообщений
✅ Ответы стали более естественными и полезными  
✅ События записываются только когда нужно
✅ Код компилируется без ошибок
✅ Совместимость с существующим API сохранена

Бот теперь стал значительно умнее и может полноценно общаться с пользователями, а не только записывать события!
